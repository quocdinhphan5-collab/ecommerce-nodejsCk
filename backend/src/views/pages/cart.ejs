<%- include('../partials/header', { title: 'Gi·ªè h√†ng' }) %>

<div class="container py-4">

  <h1 class="h3 mb-4 text-primary fw-bold">üõí Gi·ªè h√†ng</h1>

  <%
    const hasCart = cart && cart.items && cart.items.length > 0;
  %>

  <% if (!hasCart) { %>
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body text-center py-5">
        <h2 class="h5 mb-2">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</h2>
        <p class="text-muted mb-4">
          H√£y ch·ªçn nh·ªØng s·∫£n ph·∫©m y√™u th√≠ch v√† th√™m v√†o gi·ªè ƒë·ªÉ b·∫Øt ƒë·∫ßu.
        </p>
        <a href="/products" class="btn btn-primary">
          Ti·∫øp t·ª•c mua s·∫Øm
        </a>
      </div>
    </div>
  <% } else { %>

    <form method="post" action="/cart/update">
      <div class="row g-4">
        <!-- B·∫£ng s·∫£n ph·∫©m -->
        <div class="col-lg-8">
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
              <h2 class="h5 mb-3">S·∫£n ph·∫©m trong gi·ªè</h2>

              <div class="table-responsive">
                <table class="table align-middle">
                  <thead>
                    <tr>
                      <th>S·∫£n ph·∫©m</th>
                      <th>Phi√™n b·∫£n</th>
                      <th class="text-nowrap">Gi√°</th>
                      <th class="text-nowrap" style="width: 120px;">S·ªë l∆∞·ª£ng</th>
                      <th class="text-nowrap">Th√†nh ti·ªÅn</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% cart.items.forEach((it, idx) => { %>
                      <tr
                        data-cart-row
                        data-index="<%= idx %>"
                        data-price="<%= it.price %>"
                      >
                        <td>
                          <div class="fw-semibold"><%= it.name %></div>
                        </td>
                        <td><%= it.variantName || '-' %></td>
                        <td class="text-nowrap">
                          <%= it.price.toLocaleString('vi-VN') %> ‚Ç´
                        </td>
                        <td>
                          <input
                            type="number"
                            name="quantities[<%= idx %>]"
                            class="form-control form-control-sm cart-qty-input"
                            value="<%= it.quantity %>"
                            min="0"
                          >
                        </td>
                        <td class="cart-line-total text-nowrap">
                          <%= (it.price * it.quantity).toLocaleString('vi-VN') %> ‚Ç´
                        </td>
                        <td class="text-end">
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-danger btn-remove-item"
                            data-index="<%= idx %>"
                          >
                            X√≥a
                          </button>
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- T√≥m t·∫Øt gi·ªè h√†ng -->
        <div class="col-lg-4">
          <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
              <h2 class="h5 mb-3">T√≥m t·∫Øt gi·ªè h√†ng</h2>

              <p class="mb-1 small text-muted">
                S·ªë s·∫£n ph·∫©m:
                <strong>
                  <%= cart.items.reduce((sum, it) => sum + it.quantity, 0) %>
                </strong>
              </p>

              <p class="mb-3 small text-muted">
                T·∫°m t√≠nh (ch∆∞a bao g·ªìm VAT, ph√≠ ship): 
              </p>

              <p class="fs-5 fw-bold text-danger mb-3">
                <span id="cartTotal"><%= cart.total.toLocaleString('vi-VN') %></span> ‚Ç´
              </p>

              <p class="small text-muted mb-3">
                Thu·∫ø v√† ph√≠ v·∫≠n chuy·ªÉn s·∫Ω ƒë∆∞·ª£c t√≠nh ·ªü b∆∞·ªõc <strong>Thanh to√°n</strong>.
              </p>

              <div class="d-grid gap-2">
                <a href="/products" class="btn btn-outline-secondary">
                  Ti·∫øp t·ª•c mua s·∫Øm
                </a>
                <button type="button" class="btn btn-outline-danger" id="clearCartBtn">
                  X√≥a t·∫•t c·∫£
                </button>
                <a href="/checkout" class="btn btn-success">
                  Thanh to√°n
                </a>
              </div>
            </div>
          </div>
        </div>

      </div>
    </form>

  <% } %>

</div>

<script>
  (function () {
    const form = document.querySelector('form[action="/cart/update"]');

    function recalcCart() {
      const rows = document.querySelectorAll('[data-cart-row]');
      let total = 0;

      rows.forEach(row => {
        const price = Number(row.dataset.price || '0');
        const idx = row.dataset.index;
        const qtyInput = row.querySelector('input[name="quantities[' + idx + ']"]');
        const qty = Math.max(0, Number(qtyInput.value || '0'));

        const lineTotal = price * qty;
        const cell = row.querySelector('.cart-line-total');
        if (cell) {
          cell.textContent = lineTotal.toLocaleString('vi-VN') + ' ‚Ç´';
        }
        total += lineTotal;
      });

      const totalEl = document.getElementById('cartTotal');
      if (totalEl) {
        totalEl.textContent = total.toLocaleString('vi-VN');
      }
    }

    function submitUpdate() {
      if (form) {
        form.submit();
      }
    }

    // 1. T·ª± ƒë·ªông c·∫≠p nh·∫≠t khi ƒë·ªïi s·ªë l∆∞·ª£ng
    document.querySelectorAll('.cart-qty-input').forEach(input => {
      input.addEventListener('change', () => {
        recalcCart();
        submitUpdate();   // t·ª± submit form, kh√¥ng c·∫ßn b·∫•m n√∫t
      });
      input.addEventListener('input', () => {
        recalcCart();
      });
    });

    // 2. N√∫t x√≥a 1 m·∫∑t h√†ng
    document.querySelectorAll('.btn-remove-item').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = btn.dataset.index;
        const qtyInput = document.querySelector(
          'input[name="quantities[' + idx + ']"]'
        );
        if (qtyInput) {
          qtyInput.value = 0;
          recalcCart();
          submitUpdate();
        }
      });
    });

    // 3. N√∫t x√≥a t·∫•t c·∫£
    const clearBtn = document.getElementById('clearCartBtn');
    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        document.querySelectorAll('.cart-qty-input').forEach(input => {
          input.value = 0;
        });
        recalcCart();
        submitUpdate();
      });
    }

    // T√≠nh l·∫°i t·ªïng khi load trang
    recalcCart();
  })();
</script>

<%- include('../partials/footer') %>
