<%- include('../partials/header') %>

<div class="container py-4">

  <h1 class="h3 mb-4 text-primary fw-bold">üßæ Thanh to√°n</h1>

  <div class="row g-4">
    <!-- C·ªòT TR√ÅI: FORM THANH TO√ÅN -->
    <div class="col-md-7">
      <div class="card border-0 shadow-sm">
        <div class="card-body">

          <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger mb-3"><%= error %></div>
          <% } %>

          <!-- Form thanh to√°n -->
          <form method="post" action="/checkout">
            <h4 class="h5 mb-3">Th√¥ng tin giao h√†ng</h4>

            <div class="mb-3">
              <label class="form-label">H·ªç t√™n</label>
              <input
                type="text"
                name="fullName"
                class="form-control"
                value="<%= (user && user.fullName) ? user.fullName : '' %>"
                required
              >
            </div>

            <div class="mb-3">
              <label class="form-label">Email</label>
              <input
                type="email"
                name="email"
                class="form-control"
                value="<%= (user && user.email) ? user.email : '' %>"
                required
              >
              <div class="form-text">
                Email d√πng ƒë·ªÉ nh·∫≠n th√¥ng tin ƒë∆°n h√†ng v√† h√≥a ƒë∆°n.
              </div>
            </div>

            <!-- ƒê·ªãa ch·ªâ -->
            <h4 class="h6 mt-3">Ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng</h4>

            <%
              const addrList = (user && user.addresses) ? user.addresses : [];
            %>

            <select name="shippingAddress" id="shippingAddressSelect" class="form-select mb-2">
              <% if (addrList.length > 0) { %>
                <% addrList.forEach((addr, i) => { %>
                  <option value="<%= i %>" <%= addr.isDefault ? 'selected' : '' %>>
                    <%= addr.fullName %> -
                    <%= addr.addressLine %>, <%= addr.ward %>, <%= addr.district %>, <%= addr.province %>
                  </option>
                <% }) %>
              <% } else { %>
                <option value="" selected disabled>Ch∆∞a c√≥ ƒë·ªãa ch·ªâ, vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ m·ªõi b√™n d∆∞·ªõi</option>
              <% } %>
            </select>

            <% if (addrList.length > 0) { %>
              <button
                type="button"
                class="btn btn-outline-primary btn-sm mb-3"
                data-bs-toggle="modal"
                data-bs-target="#savedAddressModal">
                Qu·∫£n l√Ω ƒë·ªãa ch·ªâ ƒë√£ l∆∞u
              </button>
            <% } %>

            <% if (addrList.length === 0) { %>
              <!-- KHI CH∆ØA C√ì ƒê·ªäA CH·ªà N√ÄO: HI·ªÇN TH·ªä LU√îN FORM ƒê·ªäA CH·ªà M·ªöI -->
              <div id="newAddressSection" class="border rounded p-3 mb-3 mt-2">
                <h5 class="h6 text-primary mb-2">ƒê·ªãa ch·ªâ m·ªõi</h5>

                <div class="mb-2">
                  <label class="form-label">S·ªë nh√† / ƒê∆∞·ªùng</label>
                  <input
                    type="text"
                    name="new_addressLine"
                    class="form-control"
                    placeholder="V√≠ d·ª•: 123 Nguy·ªÖn Tr√£i"
                    required
                  >
                </div>

                <div class="row">
                  <div class="col-md-4 mb-2">
                    <label class="form-label">T·ªânh / Th√†nh ph·ªë</label>
                    <select id="province" name="new_province" class="form-select" required>
                      <option value="">-- Ch·ªçn t·ªânh / th√†nh --</option>
                    </select>
                  </div>

                  <div class="col-md-4 mb-2">
                    <label class="form-label">Qu·∫≠n / Huy·ªán</label>
                    <select id="district" name="new_district" class="form-select" required>
                      <option value="">-- Ch·ªçn qu·∫≠n / huy·ªán --</option>
                    </select>
                  </div>

                  <div class="col-md-4 mb-2">
                    <label class="form-label">Ph∆∞·ªùng / X√£</label>
                    <select id="ward" name="new_ward" class="form-select" required>
                      <option value="">-- Ch·ªçn ph∆∞·ªùng / x√£ --</option>
                    </select>
                  </div>
                </div>
              </div>
            <% } %>

            <!-- ∆ØU ƒê√ÉI & GI·∫¢M GI√Å -->
            <h4 class="h5 mt-4">∆Øu ƒë√£i & gi·∫£m gi√°</h4>

            <!-- M√É GI·∫¢M GI√Å -->
            <div class="mb-3">
              <label class="form-label">M√£ gi·∫£m gi√°</label>
              <div class="input-group">
                <input
                  type="text"
                  name="discountCode"
                  id="discountCodeInput"
                  class="form-control"
                  placeholder="Nh·∫≠p m√£ (n·∫øu c√≥)"
                >
                <button type="button" class="btn btn-outline-primary" id="btnApplyDiscount">
                  √Åp d·ª•ng
                </button>
              </div>
              <div id="discountMessage" class="form-text text-success"></div>
              <div id="discountError" class="form-text text-danger"></div>
            </div>

            <!-- S·ª¨ D·ª§NG ƒêI·ªÇM TH∆Ø·ªûNG -->
            <% if (user && user.loyaltyPoints && user.loyaltyPoints > 0) { %>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" name="usePoints" id="usePointsCheck">
                <label class="form-check-label" for="usePointsCheck">
                  S·ª≠ d·ª•ng to√†n b·ªô <strong><%= user.loyaltyPoints %></strong> ƒëi·ªÉm th∆∞·ªüng ƒë·ªÉ gi·∫£m gi√°
                </label>
              </div>
            <% } %>

            <div class="mt-4 d-flex justify-content-between">
              <a href="/cart" class="btn btn-outline-secondary">
                ‚Üê Quay l·∫°i gi·ªè h√†ng
              </a>
              <button type="submit" class="btn btn-success">
                ƒê·∫∑t h√†ng
              </button>
            </div>
          </form>

          <!-- MODAL: ƒê·ªäA CH·ªà ƒê√É L∆ØU -->
          <div class="modal fade" id="savedAddressModal" tabindex="-1" aria-labelledby="savedAddressModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="savedAddressModalLabel">ƒê·ªãa ch·ªâ giao h√†ng ƒë√£ l∆∞u</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                </div>

                <div class="modal-body">
                  <%
                    const canAddMore = addrList.length < 5;
                  %>

                  <% if (canAddMore) { %>
                    <button
                      class="btn btn-sm btn-outline-primary mb-3"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#modalAddAddress"
                      aria-expanded="false"
                      aria-controls="modalAddAddress">
                      + Th√™m ƒë·ªãa ch·ªâ m·ªõi
                    </button>

                    <div class="collapse mb-3" id="modalAddAddress">
                      <form method="post" action="/checkout/address/add">
                        <div class="row g-2">
                          <div class="col-md-6">
                            <input
                              name="fullName"
                              class="form-control form-control-sm"
                              placeholder="H·ªç t√™n"
                              value="<%= user ? user.fullName : '' %>"
                              required>
                          </div>
                          <div class="col-md-6">
                            <input
                              name="phone"
                              class="form-control form-control-sm"
                              placeholder="S·ªë ƒëi·ªán tho·∫°i"
                              value="<%= user && user.phone ? user.phone : '' %>">
                          </div>
                          <div class="col-12 mt-1">
                            <input
                              name="addressLine"
                              class="form-control form-control-sm"
                              placeholder="S·ªë nh√† / ƒê∆∞·ªùng"
                              required>
                          </div>

                          <div class="col-md-4">
                            <select id="modal_province" name="province" class="form-select form-select-sm" required>
                              <option value="">-- T·ªânh / Th√†nh ph·ªë --</option>
                            </select>
                          </div>
                          <div class="col-md-4">
                            <select id="modal_district" name="district" class="form-select form-select-sm" required>
                              <option value="">-- Qu·∫≠n / Huy·ªán --</option>
                            </select>
                          </div>
                          <div class="col-md-4">
                            <select id="modal_ward" name="ward" class="form-select form-select-sm" required>
                              <option value="">-- Ph∆∞·ªùng / X√£ --</option>
                            </select>
                          </div>
                        </div>

                        <div class="form-check mt-2">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            name="isDefault"
                            id="modal_isDefault">
                          <label class="form-check-label small" for="modal_isDefault">
                            ƒê·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
                          </label>
                        </div>

                        <div class="mt-2 d-flex justify-content-end">
                          <button type="submit" class="btn btn-sm btn-primary">L∆∞u ƒë·ªãa ch·ªâ</button>
                        </div>
                      </form>
                    </div>
                  <% } else { %>
                    <p class="text-muted">B·∫°n ƒë√£ l∆∞u t·ªëi ƒëa 5 ƒë·ªãa ch·ªâ giao h√†ng. H√£y xo√° b·ªõt n·∫øu mu·ªën th√™m ƒë·ªãa ch·ªâ m·ªõi.</p>
                  <% } %>

                  <% if (addrList.length === 0) { %>
                    <p class="text-muted mb-0">B·∫°n ch∆∞a c√≥ ƒë·ªãa ch·ªâ n√†o.</p>
                  <% } else { %>
                    <% addrList.forEach((addr, index) => { %>
                      <div class="border rounded p-2 mb-3">
                        <div class="d-flex justify-content-between">
                          <div>
                            <strong><%= addr.fullName || user.fullName %></strong>
                            <% if (addr.phone) { %>
                              <span class="text-muted"> - <%= addr.phone %></span>
                            <% } %>
                            <div class="small mt-1">
                              <%= addr.addressLine %>, <%= addr.ward %>, <%= addr.district %>, <%= addr.province %>
                            </div>
                            <% if (addr.isDefault) { %>
                              <span class="badge bg-success mt-1">M·∫∑c ƒë·ªãnh</span>
                            <% } %>
                          </div>
                          <div class="text-end">
                            <button
                              class="btn btn-link btn-sm p-0 me-2"
                              type="button"
                              data-bs-toggle="collapse"
                              data-bs-target="#addr-edit-<%= index %>"
                              aria-expanded="false"
                              aria-controls="addr-edit-<%= index %>">
                              S·ª≠a
                            </button>

                            <form
                              method="post"
                              action="/checkout/address/<%= index %>/delete"
                              class="d-inline"
                              onsubmit="return confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë·ªãa ch·ªâ n√†y?');">
                              <button type="submit" class="btn btn-link btn-sm text-danger p-0">
                                X√≥a
                              </button>
                            </form>
                          </div>
                        </div>

                        <div class="collapse mt-2" id="addr-edit-<%= index %>">
                          <form method="post" action="/checkout/address/<%= index %>/edit">
                            <div class="row g-2">
                              <div class="col-md-6">
                                <input
                                  type="text"
                                  name="fullName"
                                  class="form-control form-control-sm"
                                  placeholder="H·ªç t√™n"
                                  value="<%= addr.fullName || user.fullName %>">
                              </div>
                              <div class="col-md-6">
                                <input
                                  type="text"
                                  name="phone"
                                  class="form-control form-control-sm"
                                  placeholder="S·ªë ƒëi·ªán tho·∫°i"
                                  value="<%= addr.phone || '' %>">
                              </div>
                              <div class="col-12 mt-1">
                                <input
                                  type="text"
                                  name="addressLine"
                                  class="form-control form-control-sm mb-1"
                                  placeholder="S·ªë nh√† / ƒê∆∞·ªùng"
                                  value="<%= addr.addressLine %>">
                              </div>
                              <div class="col-md-4">
                                <input
                                  type="text"
                                  name="ward"
                                  class="form-control form-control-sm"
                                  placeholder="Ph∆∞·ªùng / X√£"
                                  value="<%= addr.ward %>">
                              </div>
                              <div class="col-md-4">
                                <input
                                  type="text"
                                  name="district"
                                  class="form-control form-control-sm"
                                  placeholder="Qu·∫≠n / Huy·ªán"
                                  value="<%= addr.district %>">
                              </div>
                              <div class="col-md-4">
                                <input
                                  type="text"
                                  name="province"
                                  class="form-control form-control-sm"
                                  placeholder="T·ªânh / Th√†nh ph·ªë"
                                  value="<%= addr.province %>">
                              </div>
                            </div>

                            <div class="form-check mt-2">
                              <input
                                class="form-check-input"
                                type="checkbox"
                                name="isDefault"
                                id="isDefault-<%= index %>"
                                <%= addr.isDefault ? 'checked' : '' %>>
                              <label class="form-check-label small" for="isDefault-<%= index %>">
                                ƒê·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
                              </label>
                            </div>

                            <div class="mt-2 d-flex justify-content-end">
                              <button type="submit" class="btn btn-sm btn-primary">
                                L∆∞u ƒë·ªãa ch·ªâ
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>
                    <% }) %>
                  <% } %>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                    ƒê√≥ng
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- C·ªòT PH·∫¢I: T√ìM T·∫ÆT ƒê∆†N H√ÄNG -->
    <div class="col-md-5">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h4 class="h5 mb-3">T√≥m t·∫Øt ƒë∆°n h√†ng</h4>

          <%
            const hasCart = cart && cart.items && cart.items.length;
            const subtotal = hasCart && cart.total ? cart.total : 0;
            const tax = Math.round(subtotal * 0.1); // VAT 10%
            const shippingFee = subtotal >= 2000000 ? 0 : 50000; // freeship t·ª´ 2tr
            const grandTotal = subtotal + tax + shippingFee;
            const maxPoints = (user && user.loyaltyPoints) ? user.loyaltyPoints : 0;
          %>

          <% if (!hasCart) { %>
            <p class="text-muted">Gi·ªè h√†ng tr·ªëng. Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi thanh to√°n.</p>
            <a href="/products" class="btn btn-primary btn-sm">
              Ti·∫øp t·ª•c mua s·∫Øm
            </a>
          <% } else { %>
            <input type="hidden" id="baseSubtotal" value="<%= subtotal %>">
            <input type="hidden" id="baseTax" value="<%= tax %>">
            <input type="hidden" id="baseShipping" value="<%= shippingFee %>">
            <input type="hidden" id="maxPoints" value="<%= maxPoints %>">

            <ul class="list-group mb-3">
              <% cart.items.forEach(function (item) { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong><%= item.name %></strong>
                    <% if (item.variantName) { %>
                      <div class="text-muted small"><%= item.variantName %></div>
                    <% } %>
                    <div class="text-muted small">S·ªë l∆∞·ª£ng: <%= item.quantity %></div>
                  </div>
                  <span class="text-nowrap">
                    <%= (item.price * item.quantity).toLocaleString('vi-VN') %> ‚Ç´
                  </span>
                </li>
              <% }) %>
              <li class="list-group-item d-flex justify-content-between">
                <span>T·ªïng t·∫°m t√≠nh</span>
                <span><%= subtotal.toLocaleString('vi-VN') %> ‚Ç´</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span>Thu·∫ø (VAT 10%)</span>
                <span><%= tax.toLocaleString('vi-VN') %> ‚Ç´</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                <span><%= shippingFee.toLocaleString('vi-VN') %> ‚Ç´</span>
              </li>

              <!-- GI·∫¢M GI√Å -->
              <li class="list-group-item d-flex justify-content-between" id="discountRow" style="display:none;">
                <span>Gi·∫£m gi√°</span>
                <div class="text-end" id="discountLines" style="white-space: pre-line;"></div>
              </li>

              <li class="list-group-item d-flex justify-content-between">
                <strong>T·ªïng c·ªông</strong>
                <strong id="grandTotalText">
                  <%= grandTotal.toLocaleString('vi-VN') %> ‚Ç´
                </strong>
              </li>
            </ul>

            <p class="small text-muted mb-0">
              <i class="bi bi-info-circle"></i>
              ƒê∆°n h√†ng t·ª´ <strong>2.000.000 ‚Ç´</strong> ƒë∆∞·ª£c mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn.
            </p>
          <% } %>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const btnApply = document.getElementById('btnApplyDiscount');
  const input = document.getElementById('discountCodeInput');
  const msg = document.getElementById('discountMessage');
  const err = document.getElementById('discountError');

  const discountRow = document.getElementById('discountRow');
  const discountLines = document.getElementById('discountLines');
  const grandTotalText = document.getElementById('grandTotalText');

  const usePointsCheckbox = document.getElementById('usePointsCheck');

  // L·∫•y gi√° tr·ªã g·ªëc t·ª´ hidden input
  const baseSubtotal = Number((document.getElementById('baseSubtotal')?.value) || 0);
  const baseTax = Number((document.getElementById('baseTax')?.value) || 0);
  const baseShipping = Number((document.getElementById('baseShipping')?.value) || 0);
  const maxPoints = Number((document.getElementById('maxPoints')?.value) || 0);

  // Bi·∫øn theo d√µi gi·∫£m gi√°
  let discountFromCode = 0;     // ti·ªÅn gi·∫£m t·ª´ m√£
  let discountFromPoints = 0;   // ti·ªÅn gi·∫£m t·ª´ ƒëi·ªÉm (points * 1000)

  function fmt(v) {
    return new Intl.NumberFormat('vi-VN').format(v);
  }

  function updateSummary() {
    const totalBefore = baseSubtotal + baseTax + baseShipping;
    let grand = totalBefore - discountFromCode - discountFromPoints;
    if (grand < 0) grand = 0;
    if (grandTotalText) {
      grandTotalText.textContent = fmt(grand) + ' ‚Ç´';
    }
    const lines = [];
    if (discountFromCode > 0) {
      lines.push('-' + fmt(discountFromCode) + ' ‚Ç´ (M√£ gi·∫£m gi√°)');
    }
    if (discountFromPoints > 0) {
      lines.push('-' + fmt(discountFromPoints) + ' ‚Ç´ (ƒêi·ªÉm th∆∞·ªüng)');
    }
    if (lines.length === 0) {
      if (discountRow) discountRow.style.display = 'none';
      if (discountLines) discountLines.textContent = '';
    } else {
      if (discountRow) discountRow.style.display = 'flex';
      if (discountLines) discountLines.textContent = lines.join('\n');
    }
  }

  // √Åp d·ª•ng m√£ gi·∫£m gi√°
  if (btnApply) {
    btnApply.addEventListener('click', async function () {
      msg.textContent = '';
      err.textContent = '';
      const code = (input.value || '').trim();
      if (!code) {
        err.textContent = 'Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°.';
        return;
      }
      try {
        const res = await fetch('/checkout/apply-discount', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ discountCode: code })
        });
        const data = await res.json();
        if (!data.success) {
          err.textContent = data.message || 'M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá.';
          msg.textContent = '';
          discountFromCode = 0;
          updateSummary();
          return;
        }
        msg.textContent = 'ƒê√£ √°p d·ª•ng m√£ gi·∫£m gi√°.';
        err.textContent = '';
        discountFromCode = data.discountValue || 0;
        updateSummary();
      } catch (e) {
        console.error('L·ªói applyDiscount:', e);
        err.textContent = 'C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.';
        msg.textContent = '';
      }
    });
  }

  // S·ª≠ d·ª•ng ƒëi·ªÉm th∆∞·ªüng (1 ƒëi·ªÉm = 1000 VND)
  if (usePointsCheckbox) {
    usePointsCheckbox.addEventListener('change', function () {
      if (this.checked) {
        discountFromPoints = maxPoints * 1000;
      } else {
        discountFromPoints = 0;
      }
      updateSummary();
    });
  }

  updateSummary();
});


// ·∫®n/hi·ªán form ƒë·ªãa ch·ªâ m·ªõi
const shippingSelect = document.getElementById("shippingAddressSelect");
const newAddressSec = document.getElementById("newAddressSection");

if (shippingSelect && newAddressSec) {
  shippingSelect.addEventListener("change", function () {
    if (this.value === "new") {
      newAddressSec.style.display = "block";
    } else {
      newAddressSec.style.display = "none";
    }
  });

  if (shippingSelect.value === "new") {
    newAddressSec.style.display = "block";
  }
}

// LOAD D·ªÆ LI·ªÜU T·ªàNH HUY·ªÜN X√É
let dataVN = {};

fetch('/data/vietnam.json')
  .then(res => res.json())
  .then(data => {
    dataVN = data;
    fillProvinceSelect('province');       
    fillProvinceSelect('modal_province');
  });

function fillProvinceSelect(selectId) {
  const provinceSelect = document.getElementById(selectId);
  if (!provinceSelect) return;
  provinceSelect.innerHTML = `<option value="">-- Ch·ªçn t·ªânh --</option>`;

  Object.entries(dataVN).forEach(([code, item]) => {
    const opt = document.createElement('option');
    opt.value = item.name;
    opt.dataset.code = code;
    opt.textContent = item.name;
    provinceSelect.appendChild(opt);
  });
}

function fillDistrictSelect(provinceCode, districtId, wardIdToClear) {
  const districtSelect = document.getElementById(districtId);
  if (!districtSelect) return;

  districtSelect.innerHTML = `<option value="">-- Ch·ªçn huy·ªán --</option>`;
  if (wardIdToClear) {
    const wardSelect = document.getElementById(wardIdToClear);
    if (wardSelect) {
      wardSelect.innerHTML = `<option value="">-- Ch·ªçn x√£ --</option>`;
    }
  }

  if (!provinceCode || !dataVN[provinceCode]) return;

  const dList = dataVN[provinceCode].districts;
  Object.entries(dList).forEach(([dCode, dVal]) => {
    const opt = document.createElement('option');
    opt.value = dVal.name;
    opt.dataset.code = dCode;
    opt.textContent = dVal.name;
    districtSelect.appendChild(opt);
  });
}

function fillWardSelect(provinceCode, districtCode, wardId) {
  const wardEl = document.getElementById(wardId);
  if (!wardEl) return;
  wardEl.innerHTML = `<option value="">-- Ch·ªçn x√£ --</option>`;

  if (!provinceCode || !districtCode) return;
  const province = dataVN[provinceCode];
  if (!province) return;
  const district = province.districts[districtCode];
  if (!district) return;

  const wList = district.wards;
  wList.forEach(w => {
    const label = (typeof w === 'string')
      ? w
      : (w.name || w.full_name || w.path || JSON.stringify(w));

    const opt = document.createElement('option');
    opt.value = label;
    opt.textContent = label;
    wardEl.appendChild(opt);
  });
}

function toggleEditForm(index) {
  const form = document.getElementById(`edit-form-${index}`);
  if (!form) return;
  form.style.display = (form.style.display === 'none' || !form.style.display)
    ? 'block'
    : 'none';
}

document.querySelectorAll('.btn-edit-address').forEach(btn => {
    btn.addEventListener('click', function () {
      const index = this.dataset.index;
      toggleEditForm(index);
    });
  });

  const provinceMain = document.getElementById('province');
const districtMain = document.getElementById('district');
const wardMain = document.getElementById('ward');

if (provinceMain) {
  provinceMain.addEventListener('change', function () {
    const code = this.options[this.selectedIndex].dataset.code;
    fillDistrictSelect(code, 'district', 'ward');
  });
}

if (districtMain && provinceMain) {
  districtMain.addEventListener('change', function () {
    const provinceCode = provinceMain.options[provinceMain.selectedIndex].dataset.code;
    const districtCode = this.options[this.selectedIndex].dataset.code;
    fillWardSelect(provinceCode, districtCode, 'ward');
  });
}

const modalProvince = document.getElementById('modal_province');
const modalDistrict = document.getElementById('modal_district');
const modalWard = document.getElementById('modal_ward');

if (modalProvince) {
  modalProvince.addEventListener('change', function () {
    const code = this.options[this.selectedIndex].dataset.code;
    fillDistrictSelect(code, 'modal_district', 'modal_ward');
  });
}

if (modalDistrict && modalProvince) {
  modalDistrict.addEventListener('change', function () {
    const provinceCode = modalProvince.options[modalProvince.selectedIndex].dataset.code;
    const districtCode = this.options[this.selectedIndex].dataset.code;
    fillWardSelect(provinceCode, districtCode, 'modal_ward');
  });
}

document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('checkoutForm');
    if (!form) return;

    const submitBtn = form.querySelector('button[type="submit"]');

    form.addEventListener('submit', function (e) {
      const ok = window.confirm(
        'B·∫°n x√°c nh·∫≠n ƒë·∫∑t h√†ng v·ªõi th√¥ng tin hi·ªán t·∫°i?'
      );
      if (!ok) {
        e.preventDefault();
        return;
      }

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerText = 'ƒêang x·ª≠ l√Ω...';
      }
    });
  });

</script>

<%- include('../partials/footer') %>
