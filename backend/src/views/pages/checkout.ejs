<%- include('../partials/header') %>

<div class="container py-4">

  <h1 class="h3 mb-4 text-primary fw-bold">üßæ Thanh to√°n</h1>

  <div class="row g-4">
    <!-- C·ªòT TR√ÅI: FORM THANH TO√ÅN -->
    <div class="col-md-7">
      <div class="card border-0 shadow-sm">
        <div class="card-body">

          <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger mb-3"><%= error %></div>
          <% } %>

          <!-- Form thanh to√°n -->
          <form method="post" action="/checkout">
            <h4 class="h5 mb-3">Th√¥ng tin giao h√†ng</h4>

            <div class="mb-3">
              <label class="form-label">H·ªç t√™n</label>
              <input
                type="text"
                name="fullName"
                class="form-control"
                value="<%= (user && user.fullName) ? user.fullName : '' %>"
                required
              >
            </div>

            <div class="mb-3">
              <label class="form-label">Email</label>
              <input
                type="email"
                name="email"
                class="form-control"
                value="<%= (user && user.email) ? user.email : '' %>"
                required
              >
              <div class="form-text">
                Email d√πng ƒë·ªÉ nh·∫≠n th√¥ng tin ƒë∆°n h√†ng v√† h√≥a ƒë∆°n.
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">ƒê·ªãa ch·ªâ giao h√†ng</label>
              <textarea
                name="address"
                class="form-control"
                rows="3"
                placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh"
              ><%= (user && user.address) ? user.address : '' %></textarea>
            </div>

            <!-- N·∫øu c√≥ danh s√°ch ƒë·ªãa ch·ªâ ƒë√£ l∆∞u -->
            <% if (user && user.addresses && user.addresses.length > 0) { %>
              <div class="mb-3">
                <label class="form-label">Ho·∫∑c ch·ªçn ƒë·ªãa ch·ªâ ƒë√£ l∆∞u</label>
                <select name="savedAddressId" class="form-select">
                  <option value="">-- Kh√¥ng ch·ªçn --</option>
                  <% user.addresses.forEach(function(addr) { %>
                    <option value="<%= addr._id %>">
                      <%= addr.fullName %> - <%= addr.phone %> - <%= addr.street %>, <%= addr.ward %>, <%= addr.district %>, <%= addr.province %>
                    </option>
                  <% }) %>
                </select>
                <div class="form-text">
                  N·∫øu ƒë·ªÉ tr·ªëng √¥ ƒë·ªãa ch·ªâ ph√≠a tr√™n, h·ªá th·ªëng s·∫Ω d√πng ƒë·ªãa ch·ªâ ƒë∆∞·ª£c ch·ªçn ·ªü ƒë√¢y.
                </div>
              </div>
            <% } %>

            <!-- ∆ØU ƒê√ÉI & GI·∫¢M GI√Å -->
            <h4 class="h5 mt-4">∆Øu ƒë√£i & gi·∫£m gi√°</h4>

            <!-- M√É GI·∫¢M GI√Å -->
            <div class="mb-3">
              <label class="form-label">M√£ gi·∫£m gi√°</label>
              <div class="input-group">
                <input
                  type="text"
                  name="discountCode"
                  id="discountCodeInput"
                  class="form-control"
                  placeholder="Nh·∫≠p m√£ (n·∫øu c√≥)"
                >
                <button type="button" class="btn btn-outline-primary" id="btnApplyDiscount">
                  √Åp d·ª•ng
                </button>
              </div>
              <div id="discountMessage" class="form-text text-success"></div>
              <div id="discountError" class="form-text text-danger"></div>
            </div>

            <!-- S·ª¨ D·ª§NG ƒêI·ªÇM TH∆Ø·ªûNG -->
            <% if (user && user.loyaltyPoints && user.loyaltyPoints > 0) { %>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" name="usePoints" id="usePointsCheck">
                <label class="form-check-label" for="usePointsCheck">
                  S·ª≠ d·ª•ng to√†n b·ªô <strong><%= user.loyaltyPoints %></strong> ƒëi·ªÉm th∆∞·ªüng ƒë·ªÉ gi·∫£m gi√°
                </label>
              </div>
            <% } %>

            <div class="mt-4 d-flex justify-content-between">
              <a href="/cart" class="btn btn-outline-secondary">
                ‚Üê Quay l·∫°i gi·ªè h√†ng
              </a>
              <button type="submit" class="btn btn-success">
                ƒê·∫∑t h√†ng
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- C·ªòT PH·∫¢I: T√ìM T·∫ÆT ƒê∆†N H√ÄNG -->
    <div class="col-md-5">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h4 class="h5 mb-3">T√≥m t·∫Øt ƒë∆°n h√†ng</h4>

          <%
            const hasCart = cart && cart.items && cart.items.length;
            const subtotal = hasCart && cart.total ? cart.total : 0;
            const tax = Math.round(subtotal * 0.1); // VAT 10%
            const shippingFee = subtotal >= 2000000 ? 0 : 50000; // freeship t·ª´ 2tr
            const grandTotal = subtotal + tax + shippingFee;
            const maxPoints = (user && user.loyaltyPoints) ? user.loyaltyPoints : 0;
          %>

          <% if (!hasCart) { %>
            <p class="text-muted">Gi·ªè h√†ng tr·ªëng. Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi thanh to√°n.</p>
            <a href="/products" class="btn btn-primary btn-sm">
              Ti·∫øp t·ª•c mua s·∫Øm
            </a>
          <% } else { %>
            <input type="hidden" id="baseSubtotal" value="<%= subtotal %>">
            <input type="hidden" id="baseTax" value="<%= tax %>">
            <input type="hidden" id="baseShipping" value="<%= shippingFee %>">
            <input type="hidden" id="maxPoints" value="<%= maxPoints %>">

            <ul class="list-group mb-3">
              <% cart.items.forEach(function (item) { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong><%= item.name %></strong>
                    <% if (item.variantName) { %>
                      <div class="text-muted small"><%= item.variantName %></div>
                    <% } %>
                    <div class="text-muted small">S·ªë l∆∞·ª£ng: <%= item.quantity %></div>
                  </div>
                  <span class="text-nowrap">
                    <%= (item.price * item.quantity).toLocaleString('vi-VN') %> ‚Ç´
                  </span>
                </li>
              <% }) %>
              <li class="list-group-item d-flex justify-content-between">
                <span>T·ªïng t·∫°m t√≠nh</span>
                <span><%= subtotal.toLocaleString('vi-VN') %> ‚Ç´</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span>Thu·∫ø (VAT 10%)</span>
                <span><%= tax.toLocaleString('vi-VN') %> ‚Ç´</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                <span><%= shippingFee.toLocaleString('vi-VN') %> ‚Ç´</span>
              </li>

              <!-- GI·∫¢M GI√Å -->
              <li class="list-group-item d-flex justify-content-between" id="discountRow" style="display:none;">
                <span>Gi·∫£m gi√°</span>
                <div class="text-end" id="discountLines" style="white-space: pre-line;"></div>
              </li>

              <li class="list-group-item d-flex justify-content-between">
                <strong>T·ªïng c·ªông</strong>
                <strong id="grandTotalText">
                  <%= grandTotal.toLocaleString('vi-VN') %> ‚Ç´
                </strong>
              </li>
            </ul>

            <p class="small text-muted mb-0">
              <i class="bi bi-info-circle"></i>
              ƒê∆°n h√†ng t·ª´ <strong>2.000.000 ‚Ç´</strong> ƒë∆∞·ª£c mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn.
            </p>
          <% } %>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const btnApply = document.getElementById('btnApplyDiscount');
  const input = document.getElementById('discountCodeInput');
  const msg = document.getElementById('discountMessage');
  const err = document.getElementById('discountError');

  const discountRow = document.getElementById('discountRow');
  const discountLines = document.getElementById('discountLines');
  const grandTotalText = document.getElementById('grandTotalText');

  const usePointsCheckbox = document.getElementById('usePointsCheck');

  // L·∫•y gi√° tr·ªã g·ªëc t·ª´ hidden input
  const baseSubtotal = Number((document.getElementById('baseSubtotal')?.value) || 0);
  const baseTax = Number((document.getElementById('baseTax')?.value) || 0);
  const baseShipping = Number((document.getElementById('baseShipping')?.value) || 0);
  const maxPoints = Number((document.getElementById('maxPoints')?.value) || 0);

  // Bi·∫øn theo d√µi gi·∫£m gi√°
  let discountFromCode = 0;     // ti·ªÅn gi·∫£m t·ª´ m√£
  let discountFromPoints = 0;   // ti·ªÅn gi·∫£m t·ª´ ƒëi·ªÉm (points * 1000)

  function fmt(v) {
    return new Intl.NumberFormat('vi-VN').format(v);
  }

  function updateSummary() {
    const totalBefore = baseSubtotal + baseTax + baseShipping;
    let grand = totalBefore - discountFromCode - discountFromPoints;
    if (grand < 0) grand = 0;
    if (grandTotalText) {
      grandTotalText.textContent = fmt(grand) + ' ‚Ç´';
    }
    const lines = [];
    if (discountFromCode > 0) {
      lines.push('-' + fmt(discountFromCode) + ' ‚Ç´ (M√£ gi·∫£m gi√°)');
    }
    if (discountFromPoints > 0) {
      lines.push('-' + fmt(discountFromPoints) + ' ‚Ç´ (ƒêi·ªÉm th∆∞·ªüng)');
    }
    if (lines.length === 0) {
      if (discountRow) discountRow.style.display = 'none';
      if (discountLines) discountLines.textContent = '';
    } else {
      if (discountRow) discountRow.style.display = 'flex';
      if (discountLines) discountLines.textContent = lines.join('\n');
    }
  }

  // √Åp d·ª•ng m√£ gi·∫£m gi√°
  if (btnApply) {
    btnApply.addEventListener('click', async function () {
      msg.textContent = '';
      err.textContent = '';
      const code = (input.value || '').trim();
      if (!code) {
        err.textContent = 'Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°.';
        return;
      }
      try {
        const res = await fetch('/checkout/apply-discount', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ discountCode: code })
        });
        const data = await res.json();
        if (!data.success) {
          err.textContent = data.message || 'M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá.';
          msg.textContent = '';
          discountFromCode = 0;
          updateSummary();
          return;
        }
        msg.textContent = 'ƒê√£ √°p d·ª•ng m√£ gi·∫£m gi√°.';
        err.textContent = '';
        discountFromCode = data.discountValue || 0;
        updateSummary();
      } catch (e) {
        console.error('L·ªói applyDiscount:', e);
        err.textContent = 'C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.';
        msg.textContent = '';
      }
    });
  }

  // S·ª≠ d·ª•ng ƒëi·ªÉm th∆∞·ªüng (1 ƒëi·ªÉm = 1000 VND)
  if (usePointsCheckbox) {
    usePointsCheckbox.addEventListener('change', function () {
      if (this.checked) {
        discountFromPoints = maxPoints * 1000;
      } else {
        discountFromPoints = 0;
      }
      updateSummary();
    });
  }

  updateSummary();
});
</script>

<%- include('../partials/footer') %>
