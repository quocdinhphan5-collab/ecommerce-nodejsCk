<%- include('../partials/header') %>

<div class="container py-4">

  <h1 class="h4 mb-3 text-primary fw-bold">üì¶ Chi ti·∫øt ƒë∆°n h√†ng</h1>

  <div class="row g-3">

    <!-- T√ìM T·∫ÆT ƒê∆†N H√ÄNG -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h2 class="h5 mb-3">Th√¥ng tin chung</h2>

          <p class="mb-1 small text-muted">M√£ ƒë∆°n</p>
          <p class="fw-semibold"><%= order._id %></p>

          <p class="mb-1 small text-muted">Ng√†y ƒë·∫∑t</p>
          <p class="fw-semibold">
            <%= order.createdAt.toLocaleString('vi-VN') %>
          </p>

          <p class="mb-1 small text-muted">Tr·∫°ng th√°i hi·ªán t·∫°i</p>
          <p class="fw-semibold mb-2">
            <span
              class="badge
                <%= order.status === 'Pending'   ? 'bg-secondary' :
                    order.status === 'Confirmed' ? 'bg-primary'   :
                    order.status === 'Shipping'  ? 'bg-warning text-dark' :
                    order.status === 'Delivered' ? 'bg-success'   :
                    order.status === 'Cancelled' ? 'bg-danger'    :
                                                    'bg-info' %>">
              <%= order.status %>
            </span>
          </p>

          <% if (order.email) { %>
            <p class="mb-1 small text-muted">Email</p>
            <p class="fw-semibold"><%= order.email %></p>
          <% } %>

          <% if (order.shippingAddress) { %>
            <p class="mb-1 small text-muted">ƒê·ªãa ch·ªâ giao h√†ng</p>
            <p class="fw-semibold"><%= order.shippingAddress %></p>
          <% } %>
        </div>
      </div>

      <!-- T·ªîNG QUAN TI·ªÄN -->
      <%
        const subtotal = order.items.reduce(
          (sum, it) => sum + it.price * it.quantity,
          0
        );
        const tax = Math.round(subtotal * 0.1);           // VAT 10%
        const discountValue = order.discountValue || 0;   // ti·ªÅn t·ª´ m√£ gi·∫£m gi√°
        const usedPoints = order.usedLoyaltyPoints || 0;  // s·ªë ƒëi·ªÉm ƒë√£ d√πng
        const discountFromPoints = usedPoints * 1000;     // ti·ªÅn t·ª´ ƒëi·ªÉm th∆∞·ªüng
      %>

      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h2 class="h5 mb-3">T·ªïng ti·ªÅn</h2>

          <ul class="list-group mb-2">
            <li class="list-group-item d-flex justify-content-between">
              <span>T·ªïng ti·ªÅn h√†ng</span>
              <span><%= subtotal.toLocaleString('vi-VN') %> ‚Ç´</span>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Thu·∫ø (VAT 10%)</span>
              <span><%= tax.toLocaleString('vi-VN') %> ‚Ç´</span>
            </li>

            <% if (discountValue > 0 || usedPoints > 0) { %>
              <li class="list-group-item">
                <strong>Gi·∫£m gi√°:</strong><br>
                <% if (discountValue > 0) { %>
                  - <%= discountValue.toLocaleString('vi-VN') %> ‚Ç´
                  <% if (order.discountCode) { %>
                    (M√£: <%= order.discountCode.code || order.discountCode %>)
                  <% } else { %>
                    (M√£ gi·∫£m gi√°)
                  <% } %>
                  <br>
                <% } %>
                <% if (usedPoints > 0) { %>
                  - <%= discountFromPoints.toLocaleString('vi-VN') %> ‚Ç´
                  (S·ª≠ d·ª•ng <%= usedPoints.toLocaleString('vi-VN') %> ƒëi·ªÉm)
                <% } %>
              </li>
            <% } %>

            <li class="list-group-item d-flex justify-content-between">
              <strong>T·ªïng thanh to√°n</strong>
              <strong>
                <%= order.totalAmount.toLocaleString('vi-VN') %> ‚Ç´
              </strong>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- L·ªäCH S·ª¨ & S·∫¢N PH·∫®M -->
    <div class="col-lg-8">
      <!-- L·ªãch s·ª≠ tr·∫°ng th√°i -->
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
          <h2 class="h5 mb-3">L·ªãch s·ª≠ tr·∫°ng th√°i</h2>
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>Tr·∫°ng th√°i</th>
                <th>Th·ªùi gian</th>
              </tr>
            </thead>
            <tbody>
              <% order.history
                  .sort((a,b)=>b.updatedAt - a.updatedAt)
                  .forEach(h => { %>
                <tr>
                  <td><%= h.status %></td>
                  <td><%= new Date(h.updatedAt).toLocaleString('vi-VN') %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- S·∫£n ph·∫©m -->
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h2 class="h5 mb-3">S·∫£n ph·∫©m trong ƒë∆°n h√†ng</h2>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>S·∫£n ph·∫©m</th>
                  <th>Phi√™n b·∫£n</th>
                  <th class="text-nowrap">Gi√°</th>
                  <th class="text-nowrap">S·ªë l∆∞·ª£ng</th>
                  <th class="text-nowrap">Th√†nh ti·ªÅn</th>
                </tr>
              </thead>
              <tbody>
                <% order.items.forEach(it => { %>
                  <tr>
                    <td><%= it.name %></td>
                    <td><%= it.variantName || '-' %></td>
                    <td class="text-nowrap">
                      <%= it.price.toLocaleString('vi-VN') %> ‚Ç´
                    </td>
                    <td><%= it.quantity %></td>
                    <td class="text-nowrap">
                      <%= (it.price * it.quantity).toLocaleString('vi-VN') %> ‚Ç´
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<%- include('../partials/footer') %>
