<%- include('../partials/header') %>

<h1><%= product ? 'Sửa sản phẩm' : 'Thêm sản phẩm' %></h1>

<form method="post" action="/admin/products/save" class="col-md-8">
  <% if (product) { %>
    <input type="hidden" name="id" value="<%= product._id %>">
  <% } %>

  <% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-danger mb-3"><%= error %></div>
  <% } %>

  <!-- Tên -->
  <div class="mb-3">
    <label class="form-label">Tên</label>
    <input
      type="text"
      name="name"
      class="form-control"
      value="<%= product ? product.name : '' %>"
      required
    >
  </div>

  <!-- Thương hiệu -->
  <div class="mb-3">
    <label class="form-label">Thương hiệu</label>
    <input
      type="text"
      name="brand"
      class="form-control"
      value="<%= product ? product.brand : '' %>"
      required
    >
  </div>

  <!-- Danh mục (dropdown) -->
  <div class="mb-3">
    <label class="form-label">Danh mục</label>
    <select name="category" class="form-select" required>
      <option value="">-- Chọn danh mục --</option>
      <% (categories || []).forEach(function(cat) { %>
        <option
          value="<%= cat.slug %>"
          <%= (product && product.category === cat.slug) ? 'selected' : '' %>
        >
          <%= cat.name %>
        </option>
      <% }) %>
    </select>
  </div>

  <!-- Biến thể sản phẩm -->
  <div class="mb-3">
    <label class="form-label">Biến thể sản phẩm</label>
    <p class="form-text">
      Ví dụ: RAM 8GB, RAM 16GB; Màu Đen, Màu Trắng...
      Mỗi biến thể có giá và tồn kho riêng.
    </p>

    <div id="variants-wrapper">
      <% const variants = product && product.variants ? product.variants : []; %>

      <% if (variants.length === 0) { %>
        <!-- Nếu chưa có biến thể nào, khởi tạo 1 dòng trống -->
        <div class="row g-2 mb-2 variant-item">
          <div class="col-md-5">
            <input
              type="text"
              name="variants[0][name]"
              class="form-control"
              placeholder="Phiên bản (VD: RAM 8GB)"
              required
            >
          </div>
          <div class="col-md-3">
            <input
              type="number"
              name="variants[0][price]"
              class="form-control"
              placeholder="Giá"
              min="0"
              required
            >
          </div>
          <div class="col-md-3">
            <input
              type="number"
              name="variants[0][stock]"
              class="form-control"
              placeholder="Tồn kho"
              min="0"
              required
            >
          </div>
          <div class="col-md-1 d-flex align-items-center">
            <button type="button" class="btn btn-sm btn-outline-danger btn-remove-variant">
              ✕
            </button>
          </div>
        </div>
      <% } else { %>
        <% variants.forEach((v, idx) => { %>
          <div class="row g-2 mb-2 variant-item">
            <div class="col-md-5">
              <input
                type="text"
                name="variants[<%= idx %>][name]"
                class="form-control"
                value="<%= v.name %>"
                placeholder="Phiên bản"
                required
              >
            </div>
            <div class="col-md-3">
              <input
                type="number"
                name="variants[<%= idx %>][price]"
                class="form-control"
                value="<%= v.price %>"
                min="0"
                required
              >
            </div>
            <div class="col-md-3">
              <input
                type="number"
                name="variants[<%= idx %>][stock]"
                class="form-control"
                value="<%= v.stock %>"
                min="0"
                required
              >
            </div>
            <div class="col-md-1 d-flex align-items-center">
              <button type="button" class="btn btn-sm btn-outline-danger btn-remove-variant">
                ✕
              </button>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>

    <button
      type="button"
      class="btn btn-sm btn-outline-secondary mt-2"
      id="btn-add-variant"
    >
      + Thêm phiên bản
    </button>
  </div>

  <!-- Flags -->
  <div class="mb-3 form-check">
    <input
      type="checkbox"
      class="form-check-input"
      id="isNew"
      name="isNew"
      <%= product && product.isNew ? 'checked' : '' %>
    >
    <label class="form-check-label" for="isNew">Sản phẩm mới</label>
  </div>

  <div class="mb-3 form-check">
    <input
      type="checkbox"
      class="form-check-input"
      id="isBestSeller"
      name="isBestSeller"
      <%= product && product.isBestSeller ? 'checked' : '' %>
    >
    <label class="form-check-label" for="isBestSeller">Sản phẩm bán chạy</label>
  </div>

  <!-- Mô tả -->
  <div class="mb-3">
    <label class="form-label">Mô tả</label>
    <textarea
      name="description"
      id="description"
      class="form-control"
      rows="5"
      required
      placeholder="Nhập mô tả chi tiết, tối thiểu 5 dòng (mỗi ý một dòng)..."
    ><%= product ? product.description : '' %></textarea>
  </div>

  <!-- Ảnh -->
  <div class="mb-3">
    <label class="form-label">Danh sách ảnh (mỗi dòng một URL)</label>
    <textarea
      name="images"
      class="form-control"
      rows="3"
    ><%= product && product.images ? product.images.join('\n') : '' %></textarea>
  </div>

  <button class="btn btn-primary">Lưu</button>
  <a href="/admin/products" class="btn btn-secondary">Hủy</a>
</form>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('btn-add-variant');
    const wrapper = document.getElementById('variants-wrapper');

    function getVariantCount() {
      return wrapper.querySelectorAll('.variant-item').length;
    }

    if (btn && wrapper) {
      // Thêm biến thể mới
      btn.addEventListener('click', () => {
        const index = getVariantCount();
        const div = document.createElement('div');
        div.className = 'row g-2 mb-2 variant-item';
        div.innerHTML = `
          <div class="col-md-5">
            <input
              type="text"
              name="variants[${index}][name]"
              class="form-control"
              placeholder="Phiên bản"
              required
            >
          </div>
          <div class="col-md-3">
            <input
              type="number"
              name="variants[${index}][price]"
              class="form-control"
              placeholder="Giá"
              min="0"
              required
            >
          </div>
          <div class="col-md-3">
            <input
              type="number"
              name="variants[${index}][stock]"
              class="form-control"
              placeholder="Tồn kho"
              min="0"
              required
            >
          </div>
          <div class="col-md-1 d-flex align-items-center">
            <button type="button" class="btn btn-sm btn-outline-danger btn-remove-variant">
              ✕
            </button>
          </div>
        `;
        wrapper.appendChild(div);
      });

      // Xóa biến thể (event delegation)
      wrapper.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-remove-variant')) {
          const row = e.target.closest('.variant-item');
          if (row && getVariantCount() > 1) {
            row.remove();
          }
        }
      });
    }

    // ==== VALIDATE MÔ TẢ: TỐI THIỂU 5 DÒNG ====
    const form = document.querySelector('form[action="/admin/products/save"]');
    const desc = document.getElementById('description');

    if (form && desc) {
      form.addEventListener('submit', (e) => {
        const lines = (desc.value || '')
          .split('\n')
          .map(l => l.trim())
          .filter(l => l !== '');

        if (lines.length < 5) {
          e.preventDefault();
          alert('Mô tả sản phẩm phải có ít nhất 5 dòng nội dung.');
          desc.focus();
        }
      });
    }
  });
</script>

<%- include('../partials/footer') %>
