<%- include('../partials/header') %>

<%
  const safeRange = (typeof range !== 'undefined' && range) ? range : 'month';
  const safeStart = (typeof start !== 'undefined' && start) ? new Date(start) : null;
  const safeEnd   = (typeof end   !== 'undefined' && end)   ? new Date(end)   : null;
  const safeStats = (typeof stats !== 'undefined' && stats) ? stats : {};
  const totalUsers   = safeStats.totalUsers   || 0;
  const newUsers     = safeStats.newUsers     || 0;
  const totalOrders  = safeStats.totalOrders  || 0;
  const totalRevenue = safeStats.totalRevenue || 0;
  const safeTopProducts = (typeof topProducts !== 'undefined' && topProducts)
    ? topProducts
    : [];
  const safeChartData = (typeof chartData !== 'undefined' && chartData)
    ? chartData
    : {};
  const chartLabels   = safeChartData.labels        || [];
  const revenueSeries = safeChartData.revenueSeries || [];
  const orderSeries   = safeChartData.orderSeries   || [];
%>


<h1 class="mt-3 mb-4">Bảng điều khiển</h1>

<div class="mb-3">
  <a href="/admin/products"   class="btn btn-primary me-2">Quản lý sản phẩm</a>
  <a class="dropdown-item" href="/admin/categories">Quản lý danh mục</a>
  <a href="/admin/orders"     class="btn btn-outline-secondary me-2">Quản lý đơn hàng</a>
  <a href="/admin/discounts"  class="btn btn-outline-secondary me-2">Mã giảm giá</a>
  <a href="/admin/users"      class="btn btn-outline-secondary">Quản lý người dùng</a>
</div>

<form class="row g-2 mb-4" method="get" action="/admin">
  <div class="col-auto">
    <label for="range" class="form-label">Khoảng thời gian</label>
    <select id="range" name="range" class="form-select">
      <option value="year"    <%= safeRange === 'year' ? 'selected' : '' %>>Năm nay</option>
      <option value="quarter" <%= safeRange === 'quarter' ? 'selected' : '' %>>Quý này</option>
      <option value="month"   <%= safeRange === 'month' ? 'selected' : '' %>>Tháng này</option>
      <option value="week"    <%= safeRange === 'week' ? 'selected' : '' %>>Tuần này</option>
      <option value="custom"  <%= safeRange === 'custom' ? 'selected' : '' %>>Tùy chọn</option>
    </select>
  </div>
  <div class="col-auto">
    <label class="form-label">Từ ngày</label>
    <input
      type="date"
      name="from"
      class="form-control"
      value="<%= (safeRange === 'custom' && safeStart) ? safeStart.toISOString().slice(0, 10) : '' %>"
    >
  </div>
  <div class="col-auto">
    <label class="form-label">Đến ngày</label>
    <input
      type="date"
      name="to"
      class="form-control"
      value="<%= (safeRange === 'custom' && safeEnd) ? safeEnd.toISOString().slice(0, 10) : '' %>"
    >
  </div>
  <div class="col-auto align-self-end">
    <button class="btn btn-primary">Lọc</button>
  </div>
</form>

<div class="row mb-4">
  <div class="col-md-3 mb-3">
    <div class="card text-bg-light">
      <div class="card-body">
        <h6 class="card-subtitle mb-1 text-muted">Tổng số người dùng</h6>
        <h3 class="card-title"><%= totalUsers %></h3>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card text-bg-light">
      <div class="card-body">
        <h6 class="card-subtitle mb-1 text-muted">Người dùng mới</h6>
        <h3 class="card-title"><%= newUsers %></h3>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card text-bg-light">
      <div class="card-body">
        <h6 class="card-subtitle mb-1 text-muted">Số đơn hàng</h6>
        <h3 class="card-title"><%= totalOrders %></h3>
      </div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card text-bg-light">
      <div class="card-body">
        <h6 class="card-subtitle mb-1 text-muted">Doanh thu</h6>
        <h3 class="card-title">
          <%= totalRevenue.toLocaleString('vi-VN') %> ₫
        </h3>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-8 mb-3">
    <div class="card">
      <div class="card-header">
        Doanh thu &amp; số đơn theo thời gian
      </div>
      <div class="card-body">
        <canvas id="revenueChart" height="120"></canvas>
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-3">
    <div class="card">
      <div class="card-header">
        Sản phẩm bán chạy
      </div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>Tên sản phẩm</th>
              <th class="text-end">Số lượng</th>
              <th class="text-end">Doanh thu</th>
            </tr>
          </thead>
          <tbody>
            <% if (!safeTopProducts.length) { %>
              <tr>
                <td colspan="3" class="text-center">Chưa có dữ liệu</td>
              </tr>
            <% } else { %>
              <% safeTopProducts.forEach(function (p) { %>
                <tr>
                  <td><%= p.name %></td>
                  <td class="text-end"><%= p.quantity %></td>
                  <td class="text-end">
                    <%= p.revenue.toLocaleString('vi-VN') %> ₫
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function () {
    const ctx = document.getElementById('revenueChart');
    if (!ctx) return;

    // LẤY DỮ LIỆU TỪ SERVER
    const labels      = JSON.parse('<%- JSON.stringify(chartLabels || []) %>');
    const revenueData = JSON.parse('<%- JSON.stringify(revenueSeries || []) %>');
    const orderData   = JSON.parse('<%- JSON.stringify(orderSeries || []) %>');

    if (!labels.length) {
      return;
    }

    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Doanh thu (₫)',
            data: revenueData,
            yAxisID: 'y1',
            tension: 0.3,
          },
          {
            label: 'Số đơn',
            data: orderData,
            yAxisID: 'y2',
            tension: 0.3,
          },
        ],
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        stacked: false,
        scales: {
          y1: {
            type: 'linear',
            position: 'left',
            title: { display: true, text: 'Doanh thu (₫)' },
          },
          y2: {
            type: 'linear',
            position: 'right',
            title: { display: true, text: 'Số đơn' },
            grid: { drawOnChartArea: false },
          },
        },
      },
    });
  })();
</script>

<%- include('../partials/footer') %>
