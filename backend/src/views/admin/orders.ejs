<%- include('../partials/header') %>

<h1 class="mt-3 mb-4">Quản lý đơn hàng</h1>

<div class="mb-3">
  <a href="/admin/dashboard" class="btn btn-outline-secondary me-2">
    ← Quay lại bảng điều khiển
  </a>
</div>

<form class="row g-2 mb-4" method="get" action="/admin/orders">
  <div class="col-md-3">
    <label class="form-label">Khoảng thời gian</label>
    <select name="range" class="form-select">
      <option value="all"       <%= range === 'all' ? 'selected' : '' %>>Tất cả</option>
      <option value="today"     <%= range === 'today' ? 'selected' : '' %>>Hôm nay</option>
      <option value="yesterday" <%= range === 'yesterday' ? 'selected' : '' %>>Hôm qua</option>
      <option value="week"      <%= range === 'week' ? 'selected' : '' %>>Tuần này</option>
      <option value="month"     <%= range === 'month' ? 'selected' : '' %>>Tháng này</option>
      <option value="custom"    <%= range === 'custom' ? 'selected' : '' %>>Khoảng thời gian cụ thể</option>
    </select>
  </div>

  <div class="col-md-2">
    <label class="form-label">Từ ngày</label>
    <input
      type="date"
      name="from"
      class="form-control"
      value="<%= from || '' %>"
    >
  </div>

  <div class="col-md-2">
    <label class="form-label">Đến ngày</label>
    <input
      type="date"
      name="to"
      class="form-control"
      value="<%= to || '' %>"
    >
  </div>

  <div class="col-md-2">
    <label class="form-label">Trạng thái</label>
    <select name="status" class="form-select">
      <option value="all"        <%= status === 'all' ? 'selected' : '' %>>Tất cả</option>
      <option value="Pending"    <%= status === 'Pending' ? 'selected' : '' %>>Đang chờ xử lý</option>
      <option value="Confirmed"  <%= status === 'Confirmed' ? 'selected' : '' %>>Đã xác nhận</option>
      <option value="Shipping"   <%= status === 'Shipping' ? 'selected' : '' %>>Đang giao</option>
      <option value="Delivered"  <%= status === 'Delivered' ? 'selected' : '' %>>Đã giao</option>
      <option value="Cancelled"  <%= status === 'Cancelled' ? 'selected' : '' %>>Đã hủy</option>
    </select>
  </div>

  <div class="col-md-2 align-self-end">
    <button class="btn btn-primary w-100">Lọc</button>
  </div>
</form>

<div class="mb-2 text-muted">
  Tổng <strong><%= totalCount %></strong> đơn hàng.
  Trang <strong><%= currentPage %></strong>/<%= totalPages %>.
</div>

<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead>
      <tr>
        <th>#</th>
        <th>Mã đơn</th>
        <th>Khách hàng</th>
        <th>Email</th>
        <th>Ngày tạo</th>
        <th class="text-end">Tổng tiền</th>
        <th>Trạng thái</th>
        <th>Thao tác</th>
      </tr>
    </thead>
    <tbody>
      <% if (!orders || !orders.length) { %>
        <tr>
          <td colspan="8" class="text-center">Không có đơn hàng nào.</td>
        </tr>
      <% } else { %>
        <% orders.forEach(function (o, idx) { %>
          <tr>
            <td><%= (currentPage - 1) * perPage + idx + 1 %></td>
            <td><code><%= o._id %></code></td>
            <td><%= o.user ? (o.user.fullName || '') : '' %></td>
            <td><%= o.email || (o.user ? o.user.email : '') || '' %></td>
            <td><%= o.createdAt ? o.createdAt.toLocaleString('vi-VN') : '' %></td>
            <td class="text-end"><%= (o.totalAmount || 0).toLocaleString('vi-VN') %> ₫</td>
            <td>
              <span class="badge bg-info"><%= o.status %></span>
            </td>
            <td>
              <a href="/admin/orders/<%= o._id %>" class="btn btn-sm btn-outline-primary">
                Xem chi tiết
              </a>
            </td>
          </tr>
        <% }) %>
      <% } %>
    </tbody>
  </table>
</div>

<% if (totalPages > 1) { %>
<nav aria-label="Phân trang đơn hàng">
  <ul class="pagination">
    <% const qBase = `status=${status}&range=${range}&from=${from||''}&to=${to||''}`; %>

    <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
      <a class="page-link"
         href="/admin/orders?page=<%= currentPage - 1 %>&<%= qBase %>">«</a>
    </li>

    <% for (let p = 1; p <= totalPages; p++) { %>
      <li class="page-item <%= p === currentPage ? 'active' : '' %>">
        <a class="page-link"
           href="/admin/orders?page=<%= p %>&<%= qBase %>">
          <%= p %>
        </a>
      </li>
    <% } %>

    <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
      <a class="page-link"
         href="/admin/orders?page=<%= currentPage + 1 %>&<%= qBase %>">»</a>
    </li>
  </ul>
</nav>
<% } %>

<%- include('../partials/footer') %>
